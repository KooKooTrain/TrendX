<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendX - Predictive Market Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0D0D0D;
            color: #E0E0E0;
            overflow: hidden;
        }
        
        .glass-card {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .bg-futuristic {
            background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%);
        }

        .trendx-accent {
            color: #4CB0FF;
        }

        .chart-container {
            height: 300px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>
<body class="bg-futuristic min-h-screen p-4 flex flex-col">

    <nav class="glass-card flex justify-between items-center px-6 py-3 mb-6 sticky top-4 z-10 w-full max-w-7xl mx-auto">
        <div class="text-2xl font-black trendx-accent">Trend<span class="text-white">X</span></div>
        <div class="flex space-x-6 text-sm font-medium">
            <a href="#" class="text-white hover:trendx-accent transition duration-200">Dashboard</a>
            <a href="#" class="text-gray-400 hover:trendx-accent transition duration-200">Model</a>
            <a href="#" class="text-gray-400 hover:trendx-accent transition duration-200">Reports</a>
            <a href="#" class="text-gray-400 hover:trendx-accent transition duration-200">Settings</a>
        </div>
        <div class="flex items-center space-x-3">
            <i data-lucide="bell" class="w-5 h-5 text-gray-400"></i>
            <div class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-500"></div>
        </div>
    </nav>
    
    <main class="flex-grow w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-2 flex flex-col space-y-6">

            <div class="glass-card p-6 h-full flex flex-col">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold">30-Day Time Series & Features</h2>
                        <p class="text-sm text-gray-400">NextEra Energy (NEE) | SDG Aligned: Green Energy</p>
                    </div>
                    <span id="stock-price" class="text-3xl font-extrabold text-white">$Loading...</span>
                </div>
                <div class="flex-grow chart-container">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>

        </div>

        <div class="lg:col-span-1 flex flex-col space-y-6">
            
            <div id="prediction-card" class="glass-card p-6 flex flex-col items-center justify-center h-[200px] transition-colors duration-500">
                <h3 class="text-lg font-semibold mb-2">Next Day Trend Prediction (T+1)</h3>
                <div id="prediction-result" class="text-6xl font-black mt-2 mb-4 text-white">...</div>
                <div class="text-sm text-gray-400">Confidence: <span id="prediction-confidence" class="font-bold text-white">...</span></div>
                <div id="prediction-status" class="text-xs mt-2 px-3 py-1 rounded-full bg-gray-700">Awaiting Model Output</div>
            </div>

            <div class="glass-card p-6 flex-grow">
                <h3 class="text-lg font-semibold mb-4">Real-Time Market Data</h3>
                <div id="market-data-loading" class="text-center py-10">
                    <div class="animate-spin inline-block w-6 h-6 border-2 border-t-2 border-t-white border-gray-600 rounded-full"></div>
                    <p class="mt-3 text-sm text-gray-400">Fetching current market metrics...</p>
                </div>
                <div id="market-data-content" class="space-y-3 hidden">
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-lg font-semibold mb-4">Classifier Performance (XGBoost)</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">ROC AUC Score:</span>
                        <span class="font-semibold text-white">0.865</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Feature Set Used:</span>
                        <span class="font-semibold text-white">VWAP, RSI(14), MACD, Volume</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Training Window:</span>
                        <span class="font-semibold text-white">365 Days</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">False Positive Rate:</span>
                        <span class="font-semibold text-white">6.2%</span>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <script>
        const apiKey = "";
        const API_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL_NAME}:generateContent`;
        const API_URL = `${BASE_URL}?key=${apiKey}`;

        const STOCK_TICKER = "NEE";
        
        const MOCK_DATA = {
            symbol: STOCK_TICKER,
            name: "NextEra Energy, Inc. (Mock Data)",
            currentPrice: 133.50,
            dailyChangePercent: 1.15,
            sentiment: "UP",
            marketNews: "(Green energy sector performing well, driven by new regulatory approvals in Q4. Investor confidence is rising as several solar and wind projects reach completion ahead of schedule. Market analysts predict sustained growth due to increasing global demand for renewable energy solutions.)",
        };

        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    if (i === 0) {
                        console.log("Attempting API call with URL:", url);
                    }
                    
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function formatPrice(value) {
            return parseFloat(value).toFixed(2);
        }
        
        function renderDashboard(data, isMock) {
            const stockPriceEl = document.getElementById('stock-price');
            const predictionResultEl = document.getElementById('prediction-result');
            const predictionConfidenceEl = document.getElementById('prediction-confidence');
            const predictionStatusEl = document.getElementById('prediction-status');
            const predictionCard = document.getElementById('prediction-card');
            const marketDataContent = document.getElementById('market-data-content');
            const marketDataLoading = document.getElementById('market-data-loading');
            
            marketDataLoading.classList.add('hidden');
            marketDataContent.classList.remove('hidden');

            const changeColor = data.dailyChangePercent >= 0 ? 'text-green-400' : 'text-red-400';
            const trendIcon = data.dailyChangePercent >= 0 ? 'arrow-up' : 'arrow-down';
            const dailyChangeFormatted = `${data.dailyChangePercent >= 0 ? '+' : ''}${data.dailyChangePercent.toFixed(2)}%`;

            stockPriceEl.innerHTML = `
                $${formatPrice(data.currentPrice)} 
                <i data-lucide="${trendIcon}" class="w-5 h-5 inline-block ${changeColor}"></i>
            `;
            stockPriceEl.classList.remove('text-green-400', 'text-red-400');
            stockPriceEl.classList.add(changeColor);
            lucide.createIcons();

            marketDataContent.innerHTML = `
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">Stock Name:</span>
                    <span class="font-semibold text-white">${data.name}</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">Daily Change:</span>
                    <span class="font-semibold ${changeColor}">${dailyChangeFormatted}</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">Sentiment (LLM):</span>
                    <span class="font-semibold text-white">${data.sentiment.toUpperCase()}</span>
                </div>
                <div>
                    <span class="text-gray-400 block mb-1">Latest News Summary:</span>
                    <p class="text-sm italic">${data.marketNews}</p>
                </div>
            `;
            
            let prediction = 'FLAT';
            let confidence = '50%';
            let statusBg = 'bg-gray-700';

            if (data.dailyChangePercent > 0.5 && data.sentiment.toUpperCase() === 'UP') {
                prediction = 'UP';
                confidence = '88.5%';
                statusBg = 'bg-green-600/50 text-green-300';
            } else if (data.dailyChangePercent < -0.5 && data.sentiment.toUpperCase() === 'DOWN') {
                prediction = 'DOWN';
                confidence = '79.1%';
                statusBg = 'bg-red-600/50 text-red-300';
            } else if (data.sentiment.toUpperCase() === 'FLAT' && Math.abs(data.dailyChangePercent) <= 0.5) {
                prediction = 'FLAT';
                confidence = '65.2%';
                statusBg = 'bg-yellow-600/50 text-yellow-300';
            }
            
            predictionResultEl.textContent = prediction;
            predictionConfidenceEl.textContent = confidence;
            
            predictionCard.classList.remove('bg-gray-800', 'bg-red-800/50', 'bg-green-800/50');
            if (prediction === 'UP') {
                predictionCard.classList.add('bg-green-800/50');
            } else if (prediction === 'DOWN') {
                predictionCard.classList.add('bg-red-800/50');
            } else {
                predictionCard.classList.add('bg-gray-800');
            }
            
            const predictionLabel = isMock ? `Prediction (MOCK): ${prediction}` : `Prediction: ${prediction}`;
            predictionStatusEl.textContent = predictionLabel;
            predictionStatusEl.className = `text-xs mt-2 px-3 py-1 rounded-full ${statusBg}`;
        }

        let timeSeriesChart;

        function initializeChart() {
            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            
            const prices = [112.50, 113.20, 114.80, 113.50, 115.90, 116.30, 117.10, 116.50, 118.00, 119.20,
                            120.10, 119.80, 121.50, 122.00, 123.10, 122.50, 123.80, 124.50, 125.10, 124.90,
                            126.00, 127.10, 128.00, 127.50, 128.90, 129.50, 130.20, 131.00, 130.50, 132.10];
            
            const sma5 = prices.map((price, index, arr) => {
                if (index < 4) return null;
                return arr.slice(index - 4, index + 1).reduce((a, b) => a + b, 0) / 5;
            });

            const labels = Array.from({ length: 30 }, (_, i) => `Day ${i + 1}`);

            timeSeriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Closing Price',
                            data: prices,
                            borderColor: '#4CB0FF',
                            backgroundColor: 'rgba(76, 176, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            fill: true,
                        },
                        {
                            label: 'SMA (5-Day Feature)',
                            data: sma5,
                            borderColor: '#888888',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0,
                            spanGaps: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#A0A0A0',
                                boxWidth: 10,
                                padding: 20,
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(20, 20, 20, 0.8)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#E0E0E0',
                            borderColor: '#4CB0FF',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 6,
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                borderColor: '#333333',
                            },
                            ticks: {
                                color: '#A0A0A0',
                            }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                borderColor: '#333333',
                            },
                            ticks: {
                                color: '#A0A0A0',
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function fetchMarketDataAndPredict() {
            const marketDataLoading = document.getElementById('market-data-loading');
            marketDataLoading.classList.remove('hidden');

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "symbol": { "type": "STRING", "description": "The stock ticker symbol." },
                    "name": { "type": "STRING", "description": "The full company name." },
                    "currentPrice": { "type": "NUMBER", "description": "The current price of the stock." },
                    "dailyChangePercent": { "type": "NUMBER", "description": "The percentage change for the day." },
                    "sentiment": { "type": "STRING", "description": "A single word (UP, DOWN, or FLAT) summarizing the market sentiment." },
                    "marketNews": { "type": "STRING", "description": "A brief, one-sentence summary of the latest market news affecting the stock." }
                },
                required: ["symbol", "name", "currentPrice", "dailyChangePercent", "sentiment", "marketNews"]
            };

            const systemPrompt = `You are a specialized market data aggregator and classifier. When given a stock query, you must use Google Search to find current, up-to-date information. Respond only with a JSON object that strictly follows the provided schema, containing the stock's name, symbol, current price, daily percentage change, a single-word sentiment (UP, DOWN, or FLAT), and a brief summary of the latest news. Do not include any introductory or concluding text outside the JSON.`;

            const userQuery = `Current stock price, daily percentage change, and latest market news for ${STOCK_TICKER} NextEra Energy`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                },
            };
            
            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("No structured data received from API.");
                }

                const data = JSON.parse(jsonText);
                
                renderDashboard(data, false);

            } catch (error) {
                console.error("Error fetching market data and prediction:", error);
                renderDashboard(MOCK_DATA, true);
            }
        }

        window.onload = function() {
            initializeChart();
            fetchMarketDataAndPredict();
            
            setInterval(fetchMarketDataAndPredict, 60000); 

            lucide.createIcons();
        };

        window.addEventListener('resize', () => {
            if (timeSeriesChart) {
                timeSeriesChart.resize();
            }
        });

    </script>
</body>
</html>